from openai import OpenAI
import logging


class ChatGPTModel:
    def __init__(self,
                 gpt_model,
                 api_key,
                 temperature,
                 top_p,
                 penal,
                 max_input_token_length):
        self.api_key = api_key
        if api_key == "":
            logging.info('Error: OpenAI API key is empty.')
            exit(1)
        self.model_id = gpt_model
        self.client = OpenAI(api_key=self.api_key)
        self.gpt_model = gpt_model
        self.temperature = temperature
        self.top_p = top_p
        self.penal = penal
        self.max_input_token_length = max_input_token_length

    def zeroshot_prompting(self, dialogue, measure):
        if measure == 'tech':
            system_prompt = ("Here are the definitions of 11 different mental manipulation techniques:\n"
                             "1. Denial: The manipulator either denies wrongdoing or pretends to be confused about others' concerns.\n"
                             "2. Evasion: The manipulator refuses to pay attention to something or gives irrelevant or vague responses.\n"
                             "3. Feigning Innocence: The manipulator implies that any harm caused was accidental.\n"
                             "4. Rationalization: The manipulator rationalizes their inappropriate behavior with excuses.\n"
                             "5. Playing the Victim Role: The manipulator portrays themselves as a victim to gain sympathy, attention, or divert focus from their misconduct.\n"
                             "6. Playing the Servant Role: The manipulator disguises their self-serving motives as a contribution to a more noble cause.\n"
                             "7. Shaming or Belittlement: The manipulator uses sarcasm, criticism, and put-downs to make others feel inferior, unworthy, or embarrassed.\n"
                             "8. Intimidation: The manipulator places others on the defensive by using veiled threats.\n"
                             "9. Brandishing Anger: The manipulator uses anger to brandish emotional intensity to shock the victim into submission.\n"
                             "10. Accusation: The manipulator suggests that the victim is at fault, selfish, uncaring, or leading an excessively easy life.\n"
                             "11. Persuasion or Seduction: The manipulator employs charm, emotional appeal, or logical reasoning to make others lower their defenses.\n\n"
                             "Now, I will provide you with a dialogue that contains elements of mental manipulation. "
                             "Please determine which manipulative techniques are used by the manipulator. "
                             "Respond only with the names of the techniques, and do not add anything else.\n\n")
        else:
            system_prompt = ("Here are the definitions of 5 different vulnerabilities targeted in victims of mental manipulation:\n"
                             "1. Naivete: The victim is easily trusting and struggles to accept that others might be malevolent.\n"
                             "2. Dependency: The victim has interest-based or emotional dependencies on the manipulator.\n"
                             "3. Over-responsibility: The victim is overly self-critical and sets high standards for themselves, often assuming undue blame and responsibility for the manipulator's actions.\n"
                             "4. Over-intellectualization: The victim rationalizes the manipulator's hurtful behavior by believing there is always a justified reason behind it.\n"
                             "5. Low self-esteem: The victim is self-doubting and unconfident in pursuing their own wants and needs.\n\n"
                             "Now, I will provide you with a dialogue that contains elements of mental manipulation. "
                             "Please determine which vulnerabilities are targeted in the victim. "
                             "Respond only with the names of the vulnerabilities, and do not add anything else.\n\n")

        response = self.client.chat.completions.create(
            model=self.gpt_model,
            temperature=self.temperature,
            top_p=self.top_p,
            frequency_penalty=self.penal,
            messages=[
                {
                    "role": "system",
                    "content": system_prompt,
                },
                {
                    "role": "user",
                    "content": dialogue,
                }
            ]
        )

        res = response.choices[0].message.content

        logging.info(system_prompt)
        logging.info(dialogue)
        logging.info('')
        logging.info(res)
        logging.info('')

        pred_list = []
        if measure == 'tech':
            if 'denial' in res.lower():
                pred_list.append("Denial")
            if "evasion" in res.lower():
                pred_list.append("Evasion")
            if "feigning innocence" in res.lower():
                pred_list.append("Feigning Innocence")
            if "rationalization" in res.lower():
                pred_list.append("Rationalization")
            if "playing the victim role" in res.lower():
                pred_list.append("Playing the Victim Role")
            if "playing the servant role" in res.lower():
                pred_list.append("Playing the Servant Role")
            if "shaming or belittlement" in res.lower():
                pred_list.append("Shaming or Belittlement")
            if "intimidation" in res.lower():
                pred_list.append("Intimidation")
            if "brandishing anger" in res.lower():
                pred_list.append("Brandishing Anger")
            if "accusation" in res.lower():
                pred_list.append("Accusation")
            if "persuasion or seduction" in res.lower():
                pred_list.append("Persuasion or Seduction")
        else:
            if 'naivete' in res.lower():
                pred_list.append("Naivete")
            if "dependency" in res.lower():
                pred_list.append("Dependency")
            if "over-responsibility" in res.lower():
                pred_list.append("Over-responsibility")
            if "over-intellectualization" in res.lower():
                pred_list.append("Over-intellectualization")
            if "low self-esteem" in res.lower():
                pred_list.append("Low self-esteem")

        return pred_list

    def fewshot_prompting(self, manip_examples, dialogue, measure):
        example_list = []
        total_example_num = len(manip_examples)
        count_example = 0
        for idx, row in manip_examples.iterrows():
            count_example += 1
            if measure == 'tech':
                row['Technique'] = row['Technique'].replace('Playing Victim Role', 'Playing the Victim Role')
                row['Technique'] = row['Technique'].replace('Playing Servant Role', 'Playing the Servant Role')
                example_answer = '\n'.join(row['Technique'].split(',')) + '\n'
            else:
                example_answer = '\n'.join(row['Vulnerability'].split(',')) + '\n'
            example = [
                {"role": "user", "content": f"Example {count_example}:\n{row['Dialogue']}"},
                {"role": "assistant", "content": example_answer},
            ]
            example_list.extend(example)

        if measure == 'tech':
            system_prompt = ("Here are the definitions of 11 different mental manipulation techniques:\n"
                             "1. Denial: The manipulator either denies wrongdoing or pretends to be confused about others' concerns.\n"
                             "2. Evasion: The manipulator refuses to pay attention to something or gives irrelevant or vague responses.\n"
                             "3. Feigning Innocence: The manipulator implies that any harm caused was accidental.\n"
                             "4. Rationalization: The manipulator rationalizes their inappropriate behavior with excuses.\n"
                             "5. Playing the Victim Role: The manipulator portrays themselves as a victim to gain sympathy, attention, or divert focus from their misconduct.\n"
                             "6. Playing the Servant Role: The manipulator disguises their self-serving motives as a contribution to a more noble cause.\n"
                             "7. Shaming or Belittlement: The manipulator uses sarcasm, criticism, and put-downs to make others feel inferior, unworthy, or embarrassed.\n"
                             "8. Intimidation: The manipulator places others on the defensive by using veiled threats.\n"
                             "9. Brandishing Anger: The manipulator uses anger to brandish emotional intensity to shock the victim into submission.\n"
                             "10. Accusation: The manipulator suggests that the victim is at fault, selfish, uncaring, or leading an excessively easy life.\n"
                             "11. Persuasion or Seduction: The manipulator employs charm, emotional appeal, or logical reasoning to make others lower their defenses.\n\n"
                             "Now, I will provide you with a dialogue that contains elements of mental manipulation. "
                             "Please determine which manipulative techniques are used by the manipulator. "
                             "Respond only with the names of the techniques, and do not add anything else. "
                             f"Here are {total_example_num} examples:\n\n")
        else:
            system_prompt = ("Here are the definitions of 5 different vulnerabilities targeted in victims of mental manipulation:\n"
                             "1. Naivete: The victim is easily trusting and struggles to accept that others might be malevolent.\n"
                             "2. Dependency: The victim has interest-based or emotional dependencies on the manipulator.\n"
                             "3. Over-responsibility: The victim is overly self-critical and sets high standards for themselves, often assuming undue blame and responsibility for the manipulator's actions.\n"
                             "4. Over-intellectualization: The victim rationalizes the manipulator's hurtful behavior by believing there is always a justified reason behind it.\n"
                             "5. Low self-esteem: The victim is self-doubting and unconfident in pursuing their own wants and needs.\n\n"
                             "Now, I will provide you with a dialogue that contains elements of mental manipulation. "
                             "Please determine which vulnerabilities are targeted in the victim. "
                             "Respond only with the names of the vulnerabilities, and do not add anything else. "
                             f"Here are {total_example_num} examples:\n\n")

        messages = [{"role": "system",
                     "content": system_prompt}]
        messages += example_list
        messages.append({"role": "user",
                         "content": dialogue})

        response = self.client.chat.completions.create(
            model=self.gpt_model,
            temperature=self.temperature,
            top_p=self.top_p,
            frequency_penalty=self.penal,
            messages=messages
        )

        res = response.choices[0].message.content

        logging.info(system_prompt)
        for example in example_list:
            logging.info(example['content'])
        logging.info('')
        logging.info(dialogue)
        logging.info('')
        logging.info(res)
        logging.info('')

        pred_list = []
        if measure == 'tech':
            if 'denial' in res.lower():
                pred_list.append("Denial")
            if "evasion" in res.lower():
                pred_list.append("Evasion")
            if "feigning innocence" in res.lower():
                pred_list.append("Feigning Innocence")
            if "rationalization" in res.lower():
                pred_list.append("Rationalization")
            if "playing the victim role" in res.lower():
                pred_list.append("Playing the Victim Role")
            if "playing the servant role" in res.lower():
                pred_list.append("Playing the Servant Role")
            if "shaming or belittlement" in res.lower():
                pred_list.append("Shaming or Belittlement")
            if "intimidation" in res.lower():
                pred_list.append("Intimidation")
            if "brandishing anger" in res.lower():
                pred_list.append("Brandishing Anger")
            if "accusation" in res.lower():
                pred_list.append("Accusation")
            if "persuasion or seduction" in res.lower():
                pred_list.append("Persuasion or Seduction")
        else:
            if 'naivete' in res.lower():
                pred_list.append("Naivete")
            if "dependency" in res.lower():
                pred_list.append("Dependency")
            if "over-responsibility" in res.lower():
                pred_list.append("Over-responsibility")
            if "over-intellectualization" in res.lower():
                pred_list.append("Over-intellectualization")
            if "low self-esteem" in res.lower():
                pred_list.append("Low self-esteem")

        return pred_list
